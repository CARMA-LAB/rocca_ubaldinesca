<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="ROCCA UBALDINESCA">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – ROCCA UBALDINESCA</title>

  <link rel="stylesheet" href="./build/potree/potree.css">
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>

  <!-- LIBS -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./build/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <!-- CONTAINER -->
  <div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
    <div id="potree_render_area"></div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import * as THREE from "./libs/three.js/build/three.module.js";

    const BUSTO_LABEL = "Busto di Francesco di Giorgio Martini";

    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
    viewer.setEDLEnabled(false);
    viewer.setFOV(60);
    viewer.setPointBudget(10_000_000);
    viewer.setDescription("ROCCA UBALDINESCA");

    viewer.loadGUI(() => {
      $("#menu_appearance").next().show();
      viewer.setEDLEnabled(false);
    });

    const BUSTO = {
      path: "./pointclouds/busto/metadata.json",
      pc: null,
      materials: []
    };

    const DEFAULTS = {
      busto: { size: 2.0, minSize: 2.0, type: Potree.PointSizeType.FIXED }
    };

    Potree.loadPointCloud(
      BUSTO.path,
      BUSTO_LABEL,
      e => {
        const pc = e.pointcloud;
        const mat = pc.material;
        mat.activeAttributeName = "rgba";
        mat.size = DEFAULTS.busto.size;
        mat.minSize = DEFAULTS.busto.minSize;
        mat.pointSizeType = DEFAULTS.busto.type;

        BUSTO.materials.push(mat);
        viewer.scene.addPointCloud(pc);
        BUSTO.pc = pc;
      }
    );

    const SAVED_POS_ARR = [298466.385, 4850600.318, 331.573];
    const SAVED_TGT_ARR = [298465.887, 4850599.271, 330.800];

    function goToSavedView(){
      viewer.scene.view.setView(SAVED_POS_ARR, SAVED_TGT_ARR);
      viewer.render();
    }

    /* =========================
       ANNOTATION WITH TEXT + IMAGE
       ========================= */

    const ann = new Potree.Annotation({
      title: BUSTO_LABEL,
      position: SAVED_TGT_ARR,
      cameraPosition: SAVED_POS_ARR,
      cameraTarget: SAVED_TGT_ARR,
      description: `
        <div style="max-width:320px; line-height:1.35;">
          
          <div style="font-weight:700; margin-bottom:6px;">
            ${BUSTO_LABEL}
          </div>

          <p style="margin:0 0 8px 0;">
            Busto attribuito a <b>Francesco di Giorgio Martini</b>,
            collocato all’interno della Rocca Ubaldinesca di Sassocorvaro.
            La nuvola di punti consente l’osservazione ravvicinata del manufatto.
          </p>

          <img
            src=".resources/images/busto.JPG"
            alt="Busto di Francesco di Giorgio Martini"
            style="width:100%; height:auto; border-radius:8px; margin:8px 0;"
          />

          <div style="font-size:12px; opacity:0.85;">
            Modello digitale da rilievo 3D.
          </div>

          <div style="margin-top:6px; font-size:12px;">
            Clicca sull’annotazione per attivare il punto di vista dedicato.
          </div>

        </div>
      `
    });

    viewer.scene.annotations.add(ann);
    ann.addEventListener("select", () => goToSavedView());
    ann.addEventListener("click",  () => goToSavedView());
    ann.onClick = () => goToSavedView();

  </script>

</body>
</html>
